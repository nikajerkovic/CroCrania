<!DOCTYPE html>
<html lang="en">

<head>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">



    <title>CroCrania</title>

</head>

<body>
    <div class = "intro_container" id="introContainer">
        <img src="{{ url_for('static', filename='crocrania4.png') }}" alt="Logo" class="logo">
        <div class="title-container">
            <h1 class="title">CroCrania</h1>
        </div>
        <div class="description-container">
            <p class="description"><p class="description">CroCrania is an app for estimating the sex of unidentified skulls developed and validated on the
                MSCT images of the
                modern Croatian population (n = 414). It enables sex estimation using standard cranial measurements as described in
                <a href="https://www.google.com/url?sa=t&rct=j&q=&esrc=s&source=web&cd=&ved=2ahUKEwiQj8GU3YSEAxUVVfEDHbFOAsYQFnoECA8QAQ&url=https%3A%2F%2Ffac.utk.edu%2Fwp-content%2Fuploads%2F2016%2F03%2FDCP20_webversion.pdf&usg=AOvVaw0pW5sFUJcHxIV7QiKNKRND&opi=89978449"
                    target="_blank">Data Collection Procedures for Forensic Skeletal Material 2.0</a>, as well as non-standard
                measurements based on distances calculated between <button id="downloadPdfLink" class="link">cranial landmarks</button>. We provided models that reached maximum accuracies, both on standard
                (0.90-0.91)
                and non-standard measurements (0.95-0.96). Since the application was developed on the Croatian population, we advise
                caution when using classification models on other populations prior to validation studies. For this reason, we
                enabled
                users to input their population data using templates or by selecting a folder with landmark files.
        </div>
    </div>

    <div class = "button-container">

        <div  class="button-container_2">
            <button type="button" id="standardButton" class="underlined-button" onclick="toggleForm('standard')">Standard Measurements</button>
            <button type="button" id="nonStandardButton" class="underlined-button" onclick="toggleForm('nonStandard')" style="margin-left: 30px;">Non-standard Measurements</button>
        </div>
    </div>

    
    <div class= "form_container">
        
        <div class="container" id="standardFormContainer"  style="display: none;">
            <p class="instruction mb-3"><strong>Instructions:</strong> Two models are available for standard measurements. The first model uses 18 standard measurements and provides
            classification using a Support Vector Machine (SVM) with an accuracy of 0.91. The second is a linear discriminant
            analysis model that employs three measurements and classifies sex with an accuracy of 0.90.
            To perform classifications, users can input data for a single cranium or upload the Excel file with measurements of
            multiple crania using the template provided. Users should enter all 18 variables (for the first model) or three
            variables marked yellow (for the second model).</p>
            
            <form id="standardPredictionForm" action="/predict" method="POST" enctype="multipart/form-data">
                <div class="form-columns">
                <div class="form-column">
                <label class="label_titles_1">Enter the measurements</label>
                </div>
                </div>
                <div class="form-columns">
                    <div class="form-column">
                        <div class="form-group">
                            <label for="GOL">GOL</label>
                            <input type="number" onkeydown="validateNumericInput(event)" onwheel="this.blur()" inputmode="decimal" pattern="-?\d*\.?\d+" class="form-control" id="GOL" name="GOL">
                        </div>

                        <div class="form-group">
                            <label for="NOL">NOL</label>
                            <input type="number" onkeydown="validateNumericInput(event)" onwheel="this.blur()" inputmode="decimal" pattern="-?\d*\.?\d+" class="form-control" id="NOL" name="NOL">
                        </div>

                        <div class="form-group">
                            <label for="XCB">XCB</label>
                            <input type="number" onkeydown="validateNumericInput(event)" onwheel="this.blur()" inputmode="decimal" pattern="-?\d*\.?\d+" class="form-control" id="XCB" name="XCB">
                        </div>
                    </div>


                    <div class="form-column">
                        <div class="form-group">
                            <label for="ZYB">ZYB</label>
                            <input type="number" onkeydown="validateNumericInput(event)" onwheel="this.blur()" inputmode="decimal" pattern="-?\d*\.?\d+" class="form-control_3" id="ZYB" name="ZYB" 
                                required>
                        </div>

                        <div class="form-group">
                            <label for="BBH">BBH</label>
                            <input type="number" onkeydown="validateNumericInput(event)" onwheel="this.blur()" inputmode="decimal" pattern="-?\d*\.?\d+" class="form-control" id="BBH" name="BBH">
                        </div>

                        <div class="form-group">
                            <label for="AUB">AUB</label>
                            <input type="number" onkeydown="validateNumericInput(event)" onwheel="this.blur()" inputmode="decimal" pattern="-?\d*\.?\d+" class="form-control" id="AUB" name="AUB">
                        </div>
                    </div>
                    <div class="form-column">
                        <div class="form-group">
                            <label for="WFB">WFB</label>
                            <input type="number" onkeydown="validateNumericInput(event)" onwheel="this.blur()" inputmode="decimal" pattern="-?\d*\.?\d+" class="form-control" id="WFB" name="WFB">
                        </div>

                        <div class="form-group">
                            <label for="NLH_L">NLH_L</label>
                            <input type="number" onkeydown="validateNumericInput(event)" onwheel="this.blur()" inputmode="decimal" pattern="-?\d*\.?\d+" class="form-control_3" id="NLH_L" name="NLH_L" required>
                        </div>

                        <div class="form-group">
                            <label for="NLH_R">NLH_R</label>
                            <input type="number" onkeydown="validateNumericInput(event)" onwheel="this.blur()" inputmode="decimal" pattern="-?\d*\.?\d+" class="form-control" id="NLH_R" name="NLH_R">
                        </div>
                    </div>

                    <div class="form-column">
                        <div class="form-group">
                            <label for="OBB_L">OBB_L</label>
                            <input type="number" onkeydown="validateNumericInput(event)" onwheel="this.blur()" inputmode="decimal" pattern="-?\d*\.?\d+" class="form-control" id="OBB_L" name="OBB_L">
                        </div>

                        <div class="form-group">
                            <label for="OBH_R">OBH_R</label>
                            <input type="number" onkeydown="validateNumericInput(event)" onwheel="this.blur()" inputmode="decimal" pattern="-?\d*\.?\d+" class="form-control_3" id="OBH_R" name="OBH_R" required>
                        </div>

                        <div class="form-group">
                            <label for="FRC">FRC</label>
                            <input type="number" onkeydown="validateNumericInput(event)" onwheel="this.blur()" inputmode="decimal" pattern="-?\d*\.?\d+" class="form-control" id="FRC" name="FRC">
                        </div>

                    </div>

                    <div class="form-column">
                        <div class="form-group">
                            <label for="PAC">PAC</label>
                            <input type="number" onkeydown="validateNumericInput(event)" onwheel="this.blur()" inputmode="decimal" pattern="-?\d*\.?\d+" class="form-control" id="PAC" name="PAC">
                        </div>

                        <div class="form-group">
                            <label for="OCC">OCC</label>
                            <input type="number" onkeydown="validateNumericInput(event)" onwheel="this.blur()" inputmode="decimal" pattern="-?\d*\.?\d+" class="form-control" id="OCC" name="OCC">
                        </div>

                        <div class="form-group">
                            <label for="FOL">FOL</label>
                            <input type="number" onkeydown="validateNumericInput(event)" onwheel="this.blur()" inputmode="decimal" pattern="-?\d*\.?\d+" class="form-control" id="FOL" name="FOL">
                        </div>
                    </div>

                    <div class="form-column">

                        <div class="form-group">
                            <label for="FOB">FOB</label>
                            <input type="number" onkeydown="validateNumericInput(event)" onwheel="this.blur()" inputmode="decimal" pattern="-?\d*\.?\d+" class="form-control" id="FOB" name="FOB">
                        </div>

                        <div class="form-group">
                            <label for="MDH_L">MDH_L</label>
                            <input type="number" onkeydown="validateNumericInput(event)" onwheel="this.blur()" inputmode="decimal" pattern="-?\d*\.?\d+" class="form-control" id="MDH_L" name="MDH_L">
                        </div>

                        <div class="form-group">
                            <label for="ZOB">ZOB</label>
                            <input type="number" onkeydown="validateNumericInput(event)" onwheel="this.blur()" inputmode="decimal" pattern="-?\d*\.?\d+" class="form-control" id="ZOB" name="ZOB">
                        </div>
                    </div>

                </div>

                
                <div class="form-columns">
                    <div class="form-column" style="display: flex;">
                        <label class="label_titles_2">Or use excel file</label>
                    </div>
                </div>

                <div class="form-columns">

                    <div class="form-column">
                        <div class = "upload-container">
                                    
                                    <div><img src="{{ url_for('static', filename='download-file.png') }}" class="icon"></div>

                                    <div style="margin-left: 5%;"><label for="excelFile" class="label">Download template</label>
                                    <div>
                                    <button id="downloadExcelButton1" class="template-btn" type="button">Template - all</button>
                                    <button id="downloadExcelButton2" class ="template3-btn" type="button">Template - 3</button></div></div>
                                    
                                
                        </div>
                    </div>

                    <div class="form-column">
                        <div class="upload-container">
                                    <div><img src="{{ url_for('static', filename='upload-file.png') }}" class="icon"></div>
                                    <div style="margin-left: 5%;"><label for="excelFile" class="label">Upload file</label>
                                    <input type="file" id="excelFile" class="form-control-file" name="excelFile"
                                        accept="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel"></div>
                        </div>               
                    </div>

                </div>

                
                <div class="form-column"  style="padding-left: 1rem;">
                    <div id="notification_empty_std" class="warning-container" style="display: none;"></div>
                    <div id="notification_validExcel" class="warning-container" style="display: none;"></div>
                </div>

                <div class="form-column" style="display: flex; justify-content: flex-start; margin-top: 1%; margin-bottom: 1%;padding-left: 1rem;">
                        <button type="button" class="custom-submit-btn" style = "margin-right: 1.5%;" onclick="predictAndShowResults_Standard()">PREDICT</button>
                        <button type="button" class="custom-submit-btn" onclick="clearForm_standard()">CLEAR</button>
                </div>


                <div id="predictionResults" class ="results"> 
                        {% if prediction_results %}
                        <div class="form-column">
                            <h1>Prediction Results</h1>
                            <table class="table" id="resultsTable">
                                <thead>
                                    <tr id="headerRow">
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for result in prediction_results %}
                                    <tr>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% endif %}
                    </div>

                </div>
            </form>

        </div>
    </div>
    

    <!-- Non-standard Measurements Form -->
    <div class="form_container">
        <div class="container" id="nonStandardFormContainer" style="display: none;">
            <p class="instruction mb-3"><strong>Instructions:</strong> Two models are available for non-standard measurements based on interlandmark distances. The first model, intended for
            manual imputation of measurements, uses 23 variables and employs a linear discriminant analysis model that provides a
            classification accuracy of 0.95. The second model reads landmark files, automatically calculates 99 interlandmark
            distances, and, using linear discriminant analysis, provides a classification accuracy of 0.96. For that model, users
            must mark landmarks in the order defined <button id="downloadPdfLink2" class="link">here</button> or use the <button id="downloadCtfLink" class="link">template</button> available for Stratovan Checkpoint software. To employthe model, a user must select a folder where landmark files are located. The app supports the following landmark file
            formats: nts,csv,pts and txt (morphologika files).</p>

            <form id="nonStandardPredictionForm" action="/predict_non_standard" method="POST" enctype="multipart/form-data">
                <div class="form-columns">
                <div class="form-column">
                    <label class="label_titles_1">Enter the measurements</label>
                </div>
                </div>
                <div class="form-columns">
                        <div class="form-column">
                            <div class="form-group">
                                <label for="ast_l_b">ast_l-b</label>
                                <input type="number" onkeydown="validateNumericInput(event)" onwheel="this.blur()" inputmode="decimal" pattern="-?\d*\.?\d+" class="form-control-non" id="ast_l_b" name="ast_l_b" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="ast_l_ms_l">ast_l-ms_l</label>
                                <input type="number" onkeydown="validateNumericInput(event)" onwheel="this.blur()" inputmode="decimal" pattern="-?\d*\.?\d+" class="form-control-non" id="ast_l_ms_l" name="ast_l_ms_l" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="b_po_r">b-po_r</label>
                                <input type="number" onkeydown="validateNumericInput(event)" onwheel="this.blur()" inputmode="decimal" pattern="-?\d*\.?\d+" class="form-control-non" id="b_po_r" name="b_po_r" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="ba_zma_l">ba-zma_l</label>
                                <input type="number" onkeydown="validateNumericInput(event)" onwheel="this.blur()" inputmode="decimal" pattern="-?\d*\.?\d+" class="form-control-non" id="ba_zma_l" name="ba_zma_l" required>
                            </div>
                        </div>
                        
                        <div class="form-column">
                            <div class="form-group">
                                <label for="en_ba_ec_l">en_ba-ec_l</label>
                                <input type="number" onkeydown="validateNumericInput(event)" onwheel="this.blur()" inputmode="decimal" pattern="-?\d*\.?\d+" class="form-control-non" id="en_ba_ec_l" name="en_ba_ec_l" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="foram_l_ec_r">foram_l-ec_r</label>
                                <input type="number" onkeydown="validateNumericInput(event)" onwheel="this.blur()" inputmode="decimal" pattern="-?\d*\.?\d+" class="form-control-non" id="foram_l_ec_r" name="foram_l_ec_r" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="ft_l_ft_r">ft_l-ft_r</label>
                                <input type="number" onkeydown="validateNumericInput(event)" onwheel="this.blur()" inputmode="decimal" pattern="-?\d*\.?\d+" class="form-control-non" id="ft_l_ft_r" name="ft_l_ft_r" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="ftm_l_ft_r">ftm_l-ft_r</label>
                                <input type="number" onkeydown="validateNumericInput(event)" onwheel="this.blur()" inputmode="decimal" pattern="-?\d*\.?\d+" class="form-control-non" id="ftm_l_ft_r" name="ftm_l_ft_r" required>
                            </div>
                        </div>

                        <div class="form-column">
                            <div class="form-group">
                                <label for="g_ns_r">g-ns_r</label>
                                <input type="number" onkeydown="validateNumericInput(event)" onwheel="this.blur()" inputmode="decimal" pattern="-?\d*\.?\d+" class="form-control-non" id="g_ns_r" name="g_ns_r" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="n_ns_l">n-ns_l</label>
                                <input type="number" onkeydown="validateNumericInput(event)" onwheel="this.blur()" inputmode="decimal" pattern="-?\d*\.?\d+" class="form-control-non" id="n_ns_l" name="n_ns_l" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="ns_r_al_r">ns_r-al_r</label>
                                <input type="number" onkeydown="validateNumericInput(event)" onwheel="this.blur()" inputmode="decimal" pattern="-?\d*\.?\d+" class="form-control-non" id="ns_r_al_r" name="ns_r_al_r" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="o_ec_r">o-ec_r</label>
                                <input type="number" onkeydown="validateNumericInput(event)" onwheel="this.blur()" inputmode="decimal" pattern="-?\d*\.?\d+" class="form-control-non" id="o_ec_r" name="o_ec_r" required>
                            </div>
                        </div>
                        

                        <div class="form-column">
                            <div class="form-group">
                                <label for="orb_d_l_ec_r">orb_d_l-ec_r</label>
                                <input type="number" onkeydown="validateNumericInput(event)" onwheel="this.blur()" inputmode="decimal" pattern="-?\d*\.?\d+" class="form-control-non" id="orb_d_l_ec_r" name="orb_d_l_ec_r" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="orb_u_l_orb_d_r">orb_u_l-orb_d_r</label>
                                <input type="number" onkeydown="validateNumericInput(event)" onwheel="this.blur()" inputmode="decimal" pattern="-?\d*\.?\d+" class="form-control-non" id="orb_u_l_orb_d_r" name="orb_u_l_orb_d_r" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="ra_l_ra_r">ra_l-ra_r</label>
                                <input type="number" onkeydown="validateNumericInput(event)" onwheel="this.blur()" inputmode="decimal" pattern="-?\d*\.?\d+" class="form-control-non" id="ra_l_ra_r" name="ra_l_ra_r" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="ra_r_b">ra_r-b</label>
                                <input type="number" onkeydown="validateNumericInput(event)" onwheel="this.blur()" inputmode="decimal" pattern="-?\d*\.?\d+" class="form-control-non" id="ra_r_b" name="ra_r_b" required>
                            </div>
                        </div>
                        
                        <div class="form-column">
                            <div class="form-group">
                                <label for="ra_r_ms_l">ra_r-ms_l</label>
                                <input type="number" onkeydown="validateNumericInput(event)" onwheel="this.blur()" inputmode="decimal" pattern="-?\d*\.?\d+" class="form-control-non" id="ra_r_ms_l" name="ra_r_ms_l" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="zo_l_ec_l">zo_l-ec_l</label>
                                <input type="number" onkeydown="validateNumericInput(event)" onwheel="this.blur()" inputmode="decimal" pattern="-?\d*\.?\d+" class="form-control-non" id="zo_l_ec_l" name="zo_l_ec_l" required>
                            </div>

                            <div class="form-group">
                                <label for="zo_l_ftm_r">zo_l-ftm_r</label>
                                <input type="number" onkeydown="validateNumericInput(event)" onwheel="this.blur()" inputmode="decimal" pattern="-?\d*\.?\d+" class="form-control-non" id="zo_l_ftm_r" name="zo_l_ftm_r" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="zy_l_ms_r">zy_l-ms_r</label>
                                <input type="number" onkeydown="validateNumericInput(event)" onwheel="this.blur()" inputmode="decimal" pattern="-?\d*\.?\d+" class="form-control-non" id="zy_l_ms_r" name="zy_l_ms_r" required>
                            </div>
                        </div>
                        
                        <div class="form-column">
                            <div class="form-group">
                                <label for="zy_l_zy_r">zy_l-zy_r</label>
                                <input type="number" onkeydown="validateNumericInput(event)" onwheel="this.blur()" inputmode="decimal" pattern="-?\d*\.?\d+" class="form-control-non" id="zy_l_zy_r" name="zy_l_zy_r" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="zy_r_b">zy_r-b</label>
                                <input type="number" onkeydown="validateNumericInput(event)" onwheel="this.blur()" inputmode="decimal" pattern="-?\d*\.?\d+" class="form-control-non" id="zy_r_b" name="zy_r_b" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="zy_r_d_l">zy_r-d_l</label>
                                <input type="number" onkeydown="validateNumericInput(event)" onwheel="this.blur()" inputmode="decimal" pattern="-?\d*\.?\d+" class="form-control-non" id="zy_r_d_l" name="zy_r_d_l" required>
                            </div>
                            
                        </div>

                </div>

                <div class="form-columns">
                    <div class="form-column" style="display: flex;">
                        <label class="label_titles_2 ">Or use folder with nts, csv, pts or txt files</label>
                    </div>
                </div>


                <div class="form-columns">
                
                    <div class="form-column">
                        <div class="upload-container">
                
                            <div><img src="{{ url_for('static', filename='download-file.png') }}" class="icon"></div>
                
                            <div style="margin-left: 5%;"><label for="fileType" class="label">Download example</label>
                                <div  class ="example-container">
                                    <select id="fileType" onfocus="this.size=4;" onblur="this.size=1;" onchange="this.size=0; this.blur();" style="padding:0.28rem; padding-left: 0.4rem; padding-right: 0;">
                                        <option value="nts" >example.nts</option>
                                        <option value="csv">example.csv</option>
                                        <option value="pts">example.pts</option>
                                        <option value="txt">example.txt</option>
                                    </select>
                                    <button id="downloadExampleButton" class="downloadButton" type="button">Download</button>
                                </div>
                            </div>
                
                
                        </div>
                    </div>
                    <div class="form-column">
                            
                            <div class="upload-container">
                                <div><img src="{{ url_for('static', filename='upload-folder.png') }}" class="icon"></div>
                                <div style="margin-left: 5%;"><label for="folderUpload">Upload Folder</label>
                                <input type="file" id="folderUpload" class="form-control-file" name="folder" webkitdirectory directory multiple>
                                </div>
                            </div>
                        
                    </div>

                    
                    </div>

                    <div class="form-column"  style="padding-left: 1rem;">
                        <div id="notification" class="warning-container" style="display: none;"></div>
                        <div id="notification_empty" class="warning-container" style="display: none;"></div>
                        <div id="notification_file_content" class="warning-container" style="display: none;"></div>
                    </div>

                <div class="form-column" style="display: flex; justify-content: flex-start; margin-top: 1%; margin-bottom: 1%; padding-left: 1rem;">
                    <button type="button" class="custom-submit-btn" style="margin-right: 1.5%;" onclick="predictAndShowResults_Non_Standard()">PREDICT</button>
                    <button type="button" class="custom-submit-btn" onclick="clearForm_non_standard()">CLEAR</button>
                </div>

                <div id="predictionResultsNonStandard" class="results">
                    {% if prediction_results %}
                    <div class="form-column">
                        <table class="table" id="resultsTable">
                            <thead>
                                <tr id="headerRow">
                            </thead>
                            <tbody>
                                {% for result in prediction_results %}
                                <tr>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                </div>
            </form>
        
        </div>
    </div>



    <script>

        
            function adjustContainerHeights() {
                var introContainer = document.getElementById('introContainer');
                var standardFormContainer = document.getElementById('standardFormContainer');
                var nonStandardFormContainer = document.getElementById('nonStandardFormContainer');

                // Reset the height to calculate the content height properly
                introContainer.style.height = 'auto';
                standardFormContainer.style.height = 'auto';
                nonStandardFormContainer.style.height = 'auto';

                // Check the display status and use the height of the visible container
                var formHeight = standardFormContainer.style.display === 'block' ? standardFormContainer.offsetHeight : nonStandardFormContainer.offsetHeight;
                var introHeight = introContainer.offsetHeight;

                // Determine the taller element
                var maxHeight = Math.max(introHeight, formHeight);

                // Set both containers to the height of the taller element
                introContainer.style.height = maxHeight + 'px';
                standardFormContainer.style.height = maxHeight + 'px';
                nonStandardFormContainer.style.height = maxHeight + 'px';
            }

            function toggleForm(formType) {
                var buttons = document.querySelectorAll('.underlined-button');
                buttons.forEach(button => {
                    button.classList.remove('active');
                });

                var standardFormContainer = document.getElementById('standardFormContainer');
                var nonStandardFormContainer = document.getElementById('nonStandardFormContainer');

                // Hide both forms initially
                standardFormContainer.style.display = 'none';
                nonStandardFormContainer.style.display = 'none';

                // Show the selected form and adjust heights accordingly
                if (formType === 'standard') {
                    standardFormContainer.style.display = 'block';
                } else if (formType === 'nonStandard') {
                    nonStandardFormContainer.style.display = 'block';
                }

                // Add the "active" class to the clicked button
                var clickedButton = document.getElementById(formType + 'Button');
                clickedButton.classList.add('active');

                // Adjust container heights
                adjustContainerHeights();
            }

            // Combined window.onload function
            window.onload = function () {
                // Set the default form to standard and adjust heights
                toggleForm('standard');
            };

            // Adjust container heights on window resize
            window.onresize = adjustContainerHeights;



        // Function to validate numeric input
            function validateNumericInput(event) {
                    const input = event.target;
                    const key = event.key;

                    // Check if the pressed key is a valid numeric character or allowed control key
                    const isValidKey = /^[-0-9.\b\t]$/.test(key); // \b for backspace, \t for tab

                    // Allow the default behavior for control keys (backspace, tab) and input value deletion
                    if (!isValidKey && key.length === 1) {
                        event.preventDefault();
                    }
                }

            document.addEventListener('DOMContentLoaded', function () {
                    // Add event listener to each input field to validate numeric input
                    var inputs = document.querySelectorAll('input[type="number"]');
                    inputs.forEach(function (input) {
                        input.addEventListener('keypress', validateNumericInput);
                    });

                    // Add event listener to handle Tab key press for focusing on the next input field
            document.addEventListener('keydown', function (event) {
                        if (event.key === 'Tab') {
                            var activeElement = document.activeElement;
                            var inputsArray = Array.from(inputs);
                            var currentIndex = inputsArray.indexOf(activeElement);
                            if (currentIndex !== -1 && currentIndex < inputsArray.length - 1) {
                                inputsArray[currentIndex + 1].focus();
                                event.preventDefault();
                            }
                        }
                    });
                });


            function downloadExcel(excelData, filename) {
                    // Create a blob object with the Excel data
                    var blob = new Blob([excelData], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });

                    // Create a link element to trigger the download
                    var link = document.createElement('a');
                    link.href = window.URL.createObjectURL(blob);
                    link.download = filename; // Use the provided filename

                    // Append the link to the body and trigger the download
                    document.body.appendChild(link);
                    link.click();

                    // Cleanup: remove the link from the body
                    document.body.removeChild(link);
                }

            // Function to fetch the content of the template file
            function fetchTemplateContent(templateName, filename, callback) {
                var xhr = new XMLHttpRequest();
                xhr.open('GET', 'static/templates/' + templateName, true);
                xhr.responseType = 'blob';

                xhr.onload = function () {
                    if (xhr.status === 200) {
                        var reader = new FileReader();
                        reader.readAsArrayBuffer(xhr.response);
                        reader.onload = function () {
                            var arrayBuffer = reader.result;
                            var byteArray = new Uint8Array(arrayBuffer);
                            var excelData = new Blob([byteArray], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                            callback(excelData, filename);
                        };
                    } else {
                        console.error('Failed to fetch template file:', xhr.status, xhr.statusText);
                    }
                };

                xhr.onerror = function () {
                    console.error('Error during download:', xhr.statusText);
                };

                xhr.send();
            }

            // Attach the downloadExcel function to the button click event
            document.getElementById('downloadExcelButton1').addEventListener('click', function () {
                var templateName = "template-veliki.xlsx"; // Change this data for the first file
                var filename = "template-all.xlsx"; // Change this for the first filename
                console.log("Downloading template:", templateName);
                fetchTemplateContent(templateName, filename, downloadExcel);
            });

            // Attach the downloadExcel function to the button click event
            document.getElementById('downloadExcelButton2').addEventListener('click', function () {
                var templateName = "template-mali.xlsx"; // Change this data for the second file
                var filename = "template-3.xlsx"; // Change this for the second filename
                console.log("Downloading template:", templateName);
                fetchTemplateContent(templateName, filename, downloadExcel);
            });


            function downloadFile(fileData, filename) {
                    // Create a blob object with the file data
                    var blob = new Blob([fileData], { type: 'text/plain' });

                    // Create a link element to trigger the download
                    var link = document.createElement('a');
                    link.href = window.URL.createObjectURL(blob);
                    link.download = filename; // Use the provided filename

                    // Append the link to the body and trigger the download
                    document.body.appendChild(link);
                    link.click();

                    // Cleanup: remove the link from the body
                    document.body.removeChild(link);
                }

                // Function to fetch the content of the file
                function fetchFileContent(fileType, callback) {
                    var xhr = new XMLHttpRequest();
                    xhr.open('GET', 'static/examples/example.' + fileType, true); // Adjusted path
                    xhr.responseType = 'blob';

                    xhr.onload = function () {
                        if (xhr.status === 200) {
                            var reader = new FileReader();
                            reader.readAsText(xhr.response);
                            reader.onload = function () {
                                var fileData = reader.result;
                                callback(fileData, 'example.' + fileType);
                            };
                        } else {
                            console.error('Failed to fetch file:', xhr.status, xhr.statusText);
                        }
                    };

                    xhr.onerror = function () {
                        console.error('Error during download:', xhr.statusText);
                    };

                    xhr.send();
                }

                // Attach the downloadFile function to the button click event
                document.getElementById('downloadExampleButton').addEventListener('click', function () {
                    var fileType = document.getElementById('fileType').value;

                    console.log('Downloading file with extension:', fileType);
                    fetchFileContent(fileType, downloadFile);
                });

            // download on link:
            function fetchLinkContent(fileType, callback) {
                    var xhr = new XMLHttpRequest();
                    xhr.open('GET', 'static/link.' + fileType, true);
                    xhr.responseType = 'blob';

                    xhr.onload = function () {
                        if (xhr.status === 200) {
                            var fileData = xhr.response; // No need for FileReader for PDF files
                            var filename;

                            // Set filename based on file type
                            if (fileType === 'pdf') {
                                filename = 'Cranial_landmarks.pdf';
                            } else if (fileType === 'ctf') {
                                filename = 'DCP20.cfs';
                            }

                            callback(fileData, filename, fileType);
                        } else {
                            console.error('Failed to fetch file:', xhr.status, xhr.statusText);
                        }
                    };

                    xhr.onerror = function () {
                        console.error('Error during download:', xhr.statusText);
                    };

                    xhr.send();
                }


                function downloadLink(fileData, filename, fileType) {
                        // Create a blob object with the file data
                        var blob = new Blob([fileData], { type: fileType === 'pdf' ? 'application/pdf' : 'text/plain' });

                        // Create a link element to trigger the download
                        var link = document.createElement('a');
                        link.href = window.URL.createObjectURL(blob);
                        link.download = filename; // Use the provided filename

                        // Append the link to the body and trigger the download
                        document.body.appendChild(link);
                        link.click();

                        // Cleanup: remove the link from the body
                        document.body.removeChild(link);
                    }


                // Attach the fetchFileContent function to the button click event
                document.getElementById('downloadPdfLink').addEventListener('click', function () {
                    console.log('Downloading pdf file');
                    fetchLinkContent('pdf', downloadLink);
                });

                // Attach the fetchFileContent function to the button click event
                document.getElementById('downloadCtfLink').addEventListener('click', function () {
                    console.log('Downloading ctf file');
                    fetchLinkContent('ctf', downloadLink);
                });

                // Attach the fetchFileContent function to the button click event
                document.getElementById('downloadPdfLink2').addEventListener('click', function () {
                    console.log('Downloading pdf file');
                    fetchLinkContent('pdf', downloadLink);
                });

            // make sure that all input fields are filled
            function check_empty() {
                    var folderInput = document.getElementById('folderUpload');

                    // Check if a folder is uploaded
                    if (folderInput.files.length) {
                        // Hide the notification if a folder is uploaded
                        var notification = document.getElementById('notification_empty');
                        notification.style.display = 'none';
                        return true;
                    }

                    // If no folder is uploaded, check if input fields are filled
                    var form = document.getElementById('nonStandardPredictionForm');
                    var inputs = form.querySelectorAll('input[required]');
                    var allFieldsFilled = true;

                    inputs.forEach(function (input) {
                        if (!input.value) {
                            allFieldsFilled = false;
                        }
                    });

                    if (!allFieldsFilled) {
                        var notification = document.getElementById('notification_empty');
                        notification.innerText = 'Please fill all the input fields or upload a folder.';
                        notification.style.display = 'flex';
                        return false;
                    } else {
                        // Hide the notification if all fields are filled
                        var notification = document.getElementById('notification_empty');
                        notification.style.display = 'none';
                    }

                    return true;
                }


          function check_empty_std() {
                // Check if an Excel file is uploaded
                var excelFileInput = document.getElementById('excelFile');
                if (excelFileInput.files.length) {
                    // Hide the notification if an Excel file is uploaded
                    var notification = document.getElementById('notification_empty_std');
                    notification.style.display = 'none';
                    return true;
                }

                // Check if required fields are filled
                var form = document.getElementById('standardPredictionForm');
                // Select all input fields with the 'required' attribute
                var requiredFields = form.querySelectorAll('input[required]');

                // Check if all fields are filled, including required and non-required fields
                var allFields = form.querySelectorAll('input:not([type="file"])');
                var isAllFieldsFilled = Array.from(allFields).every(field => field.value.trim() !== '');

                if (isAllFieldsFilled) {
                    // If all fields are filled, hide the notification and return true
                    var notification = document.getElementById('notification_empty_std');
                    notification.style.display = 'none';
                    return true;
                }

                // Check if only required fields are filled
                var isOnlyRequiredFieldsFilled = Array.from(requiredFields).every(field => field.value.trim() !== '') &&
                    Array.from(allFields).every(field => field.hasAttribute('required') || !field.value.trim());

                if (isOnlyRequiredFieldsFilled) {
                    // If only required fields are filled, hide the notification and return true
                    var notification = document.getElementById('notification_empty_std');
                    notification.style.display = 'none';
                    return true;
                }

                // If not all fields are filled or only required fields are not filled, display appropriate message
                var notification = document.getElementById('notification_empty_std');
                notification.innerText = 'Please fill only the required fields, fill all fields, or upload an Excel file.';
                notification.style.display = 'flex';
                return false;
            }

        // excel

        function showNotification(message) {
                var notificationDiv = document.getElementById('notification_validExcel');
                notificationDiv.innerText = message;
                notificationDiv.style.display = 'flex'; // Show the notification
            }

        function showNotification_non(message) {
                var notificationDiv = document.getElementById('notification_file_content');
                notificationDiv.innerText = message;
                notificationDiv.style.display = 'flex'; // Show the notification
            }

      document.getElementById('folderUpload').addEventListener('change', function () {
            var files = this.files;
            var allowedExtensions = ['.nts', '.pts', '.csv', '.txt']; // Allowed file extensions
            var allFilesValid = true;
            var extensionSet = new Set(); // Set to store unique file extensions

            for (var i = 0; i < files.length; i++) {
                var fileValid = false;
                var fileName = files[i].name.toLowerCase();

                // Check if the file has one of the allowed extensions
                for (var j = 0; j < allowedExtensions.length; j++) {
                    if (fileName.endsWith(allowedExtensions[j])) {
                        fileValid = true;
                        extensionSet.add(allowedExtensions[j]); // Add the extension to the set
                        break;
                    }
                }

                if (!fileValid) {
                    allFilesValid = false;
                    break;
                }
            }

            var notification = document.getElementById('notification');

            if (!allFilesValid) {
                // Show the notification if any file has an unsupported extension
                notification.innerText = 'Uploaded folder contains files with unsupported extensions. Please choose files with supported extensions: .nts, .pts, .csv, or .txt.';
                notification.style.display = 'flex';
            } else if (extensionSet.size > 1) {
                // Show the notification if files have different extensions
                notification.innerText = 'Uploaded folder contains files with different extensions. Please choose files with the same extension: .nts, .pts, .csv, or .txt.';
                notification.style.display = 'flex';
            } else {
                // Hide the notification if all files have supported extensions and consistent extensions
                notification.style.display = 'none';
                notification.innerText = ''; // Clear the notification text
            }

            
        });


        function predictAndShowResults_Standard() {
                // Change this line
                var notEmpty_std = check_empty_std();
                // Change this line
                if (notEmpty_std) {
                    var form = document.getElementById('standardPredictionForm');
                    var formData = new FormData(form);

                    fetch('/predict', {
                        method: 'POST',
                        body: formData
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.json();
                        })
                        .then(results => {
                            // Check if there's an error in the response
                            if (results.error) {
                                // Display the error message
                                showNotification(results.error);
                                adjustContainerHeights()
                            } else {
                                // Process the prediction results
                                    var notificationDiv = document.getElementById('notification_validExcel');
                                    notificationDiv.style.display = 'none'; // Show the notification

                                    var predictionResults = document.getElementById('predictionResults');

                                    if (predictionResults && Array.isArray(results) && results.length > 0) {
                                        var resultHtml = '<div class="form-column"><label style="font-size: 1.2rem; margin-bottom: 1rem; margin-top: 2rem;">Prediction Results</label>';

                                            

                                        // Columns to display in the table
                                        var columns = ['Filename', 'ID', 'Female Probability', 'Male Probability', 'Prediction'];

                                        // Generate the table
                                        resultHtml += '<table class="table" id="resultsTable"><thead><tr>';
                                        columns.forEach(column => {
                                            if (results[0].hasOwnProperty(column)) {
                                                resultHtml += '<th style="color: #495057; background-color: rgba(237, 237, 233, 0.2)">' + column + '</th>';
                                            }
                                        });
                                        resultHtml += '</tr></thead><tbody>';

                                        // Populate the table with results
                                        results.forEach(result => {
                                            resultHtml += '<tr>'
                                            columns.forEach(column => {
                                                if (result.hasOwnProperty(column)) {
                                                    var value = column.includes('Probability') ? parseFloat(result[column]).toFixed(5) : result[column];
                                                    /*resultHtml += '<td style="color:#212529; font-family: "Quicksand", sans-serif;">' + value + '</td>';*/
                                                    resultHtml += `<td data-label="${column} " style="color:#212529; font-family: 'Quicksand', sans-serif;">${value}</td>`;
                                                }
                                            });
                                            resultHtml += '</tr>';
                                        });

                                        resultHtml += '</tbody></table>';

                                        resultHtml += '</div>';

                                        predictionResults.innerHTML = resultHtml;
                                        adjustContainerHeights()

                                        var resultsDiv = document.getElementById('predictionResults');
                                        if (resultsDiv) {
                                            resultsDiv.scrollIntoView({ behavior: 'smooth' });
                                        }

                                        
                                    } else {
                                        console.error('Error: Unexpected response format');
                                        adjustContainerHeights()
                                    }
                            }
                        })
                        .catch(error => console.error('Error:', error));
                        adjustContainerHeights()
                }
                adjustContainerHeights()
                
            }


            function predictAndShowResults_Non_Standard(){
                var notEmpty= check_empty();
                // Change this line
                if(notEmpty){

                        var form = document.getElementById('nonStandardPredictionForm');
                        var formData = new FormData(form);

                        fetch('/predict_non_standard', {
                            method: 'POST',
                            body: formData
                        })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('Network response was not ok');
                                }
                                return response.json();
                            })
                            .then(results => {

                                if (results.error) {
                                    // Display the error message
                                    showNotification_non(results.error);
                                    adjustContainerHeights()
                                } else {
                                    var notificationDiv = document.getElementById('notification_file_content');
                                    notificationDiv.style.display = 'none'; //

                                    var predictionResults = document.getElementById('predictionResultsNonStandard');

                                    if (predictionResults && Array.isArray(results) && results.length > 0) {
                                        var resultHtml = '<div class="form-column"><label style="font-size: 1.2rem; margin-bottom: 1rem; margin-top: 2rem;">Prediction Results</label>';

                                            resultHtml += '<table class="table" id="resultsTable"><thead><tr>';
                                            var columns = ['ID', 'Filename', 'Female Probability', 'Male Probability', 'Prediction'];

                                            columns.forEach(column => {
                                                if (results[0].hasOwnProperty(column)) {
                                                    resultHtml += '<th style="color: #495057; background-color: rgba(237, 237, 233, 0.2)">' + column + '</th>';
                                                }
                                            });

                                            resultHtml += '</tr></thead><tbody>';

                                            results.forEach(result => {
                                                resultHtml += '<tr>';
                                                columns.forEach(column => {
                                                    if (result.hasOwnProperty(column)) {
                                                        //resultHtml += '<td>' + result[column] + '</td>';
                                                        var value = column.includes('Probability') ? parseFloat(result[column]).toFixed(5) : result[column];
                                                        /*resultHtml += '<td style="color:#212529; font-family: "Quicksand", sans-serif;">' + value + '</td>';*/
                                                        resultHtml += `<td data-label="${column} " style="color:#212529; font-family: 'Quicksand', sans-serif;">${value}</td>`;

                                                        
                                                    }
                                                });
                                                resultHtml += '</tr>';
                                            });

                                            resultHtml += '</tbody></table>';
                                        resultHtml += '</div>';

                                        predictionResults.innerHTML = resultHtml;
                                        adjustContainerHeights()

                                        var resultsDiv = document.getElementById('predictionResultsNonStandard');
                                        if (resultsDiv) {
                                            resultsDiv.scrollIntoView({ behavior: 'smooth' });
                                        }
                                    
                                    } else {
                                        console.error('Error: Unexpected response format');
                                        adjustContainerHeights()
                                    }
                                }
                            })
                            .catch(error => console.error('Error:', error));
                            adjustContainerHeights()
                    
                }
                adjustContainerHeights()
            }

            function clearForm_standard(){
                document.querySelectorAll('.form-control, .form-control_3').forEach(input => {
                    input.value = '';
                });
                var excelFileInput = document.getElementById('excelFile');
                if (excelFileInput) {
                    excelFileInput.value = '';
                }
                // Clear or hide the prediction results
                var predictionResults = document.querySelector('#predictionResults');
                if (predictionResults) {
                    predictionResults.innerHTML = '';
                }

                var notification = document.getElementById('notification_empty_std');
                if (notification) {
                    notification.style.display = 'none';
                    notification.innerText = '';
                }

                 var notification = document.getElementById('notification_validExcel');
                if (notification) {
                    notification.style.display = 'none';
                    notification.innerText = '';
                }

            }

            function clearForm_non_standard(){
                document.querySelectorAll('.form-control-non').forEach(input => {
                    input.value = '';
                });

                var predictionResults = document.querySelector('#predictionResultsNonStandard');
                if (predictionResults) {
                    predictionResults.innerHTML = '';
                }

                // Clear the uploaded folder input
                var folderUploadInput = document.getElementById('folderUpload');
                if (folderUploadInput) {
                    folderUploadInput.value = ''; // Clear the value
                }

                var notification = document.getElementById('notification_empty');
                if (notification){
                notification.style.display = 'none';
                notification.innerText = '';
                }

                var notification_fields = document.getElementById('notification');
                if (notification_fields) {
                    notification_fields.style.display = 'none';
                    notification_fields.innerText = '';
                }


                var notification_fields = document.getElementById('notification_file_content');
                if (notification_fields) {
                    notification_fields.style.display = 'none';
                    notification_fields.innerText = '';
                }  
            }

    </script>

</body>

</html>
